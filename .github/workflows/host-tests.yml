name: Host Tests

on:
  push:
  pull_request:

jobs:
  host-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install build tools
        run: sudo apt-get update && sudo apt-get install -y cmake g++

      - name: Fetch ESP-IDF (Unity)
        run: git clone --depth 1 --branch v5.5.1 --recurse-submodules --shallow-submodules https://github.com/espressif/esp-idf.git "${RUNNER_TEMP}/esp-idf"

      - name: Configure
        env:
          IDF_PATH: ${{ runner.temp }}/esp-idf
        run: cmake -S test -B build-host-tests

      - name: Build
        env:
          IDF_PATH: ${{ runner.temp }}/esp-idf
        run: cmake --build build-host-tests

      - name: Run tests
        env:
          IDF_PATH: ${{ runner.temp }}/esp-idf
        run: ctest --test-dir build-host-tests --output-on-failure
